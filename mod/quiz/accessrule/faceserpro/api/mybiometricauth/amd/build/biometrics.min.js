define(['jquery'], function($) {
    const Biometrics = {
        init: function() {
            this.videoElement = document.getElementById('webcam');
            this.canvasElement = document.getElementById('captureCanvas');
            this.startCaptureButton = document.getElementById('startCapture');
            this.validateCaptureButton = document.getElementById('validateCapture');
            this.retryCaptureButton = document.getElementById('retryCapture');

            this.setupEventListeners();
            this.startWebcam();
        },

        setupEventListeners: function() {
            const self = this;

            this.startCaptureButton.addEventListener('click', function() {
                self.captureImage();
            });

            this.validateCaptureButton.addEventListener('click', function() {
                self.validateImage();
            });

            this.retryCaptureButton.addEventListener('click', function() {
                self.retryCapture();
            });
        },

        startWebcam: function() {
            navigator.mediaDevices
                .getUserMedia({ video: true })
                .then(stream => {
                    this.videoElement.srcObject = stream;
                    this.videoElement.play();
                })
                .catch(error => {
                    console.error('Error accessing webcam:', error);
                    alert('Unable to access the webcam. Please check your browser permissions.');
                });
        },

        captureImage: function() {
            const context = this.canvasElement.getContext('2d');
            this.canvasElement.style.display = 'block';
            this.videoElement.style.display = 'none';
            this.startCaptureButton.style.display = 'none';
            this.validateCaptureButton.style.display = 'inline-block';

            // Draw the current frame from the video onto the canvas
            context.drawImage(this.videoElement, 0, 0, this.canvasElement.width, this.canvasElement.height);
        },

        validateImage: function() {
            const self = this;
            const base64Image = this.canvasElement.toDataURL('image/png').split(',')[1];

            const cpf = prompt('Por favor, insira seu CPF para validação:'); // Simples entrada de CPF
            if (!cpf) {
                alert('CPF é obrigatório para validação.');
                return;
            }

            // Dados da API
            const apiUrl = M.cfg.wwwroot + '/mod/quiz/accessrule/mybiometricauth/validate.php';
            const data = {
                cpf: cpf,
                validacao: {
                    biometria_facial: {
                        formato: 'png',
                        base64: base64Image,
                        vivacidade: true
                    }
                }
            };

            $.ajax({
                url: apiUrl,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    if (response.match) {
                        alert('Validação bem-sucedida! Você pode acessar o quiz.');
                        $('#biometric-modal').modal('hide');
                    } else {
                        alert('Falha na validação biométrica. Por favor, tente novamente.');
                        self.retryCapture();
                    }
                },
                error: function(xhr) {
                    console.error('Erro na validação:', xhr.responseText);
                    alert('Erro ao validar a imagem. Por favor, tente novamente.');
                    self.retryCapture();
                }
            });
        },

        retryCapture: function() {
            this.videoElement.style.display = 'block';
            this.canvasElement.style.display = 'none';
            this.startCaptureButton.style.display = 'inline-block';
            this.validateCaptureButton.style.display = 'none';
        }
    };

    return Biometrics;
});
